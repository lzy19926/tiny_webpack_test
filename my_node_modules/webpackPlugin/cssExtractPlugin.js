const path = require('path')
const fs = require('fs')

class CssExtractPlugin {
    constructor({ fileName }) {
        this.fileName = fileName || 'index.css'
    }

    bundleCSS(compilation) {
        let cssCode = ``

        compilation.Manifast.forEach(module => {
            module.dependencies.forEach((depPath) => {
                const suffix = depPath.split('.').pop()
                if (suffix === 'css') {
                    const absolutePath = module.mapping[depPath]
                    const fileContent = fs.readFileSync(absolutePath, 'utf-8')
                    compilation.dependenciesList.add(absolutePath)
                    cssCode += fileContent + '\n\n'
                }
            })
        });

        return cssCode
    }

    extractCSS(compilation) {
        const cssCode = this.bundleCSS(compilation)
        const filePath = path.join(compilation.config.output, this.fileName)
        fs.writeFileSync(filePath, cssCode)
    }

    run(compilation) {
        //todo 将extractCSS注册到webpack的afterDistSync钩子队列  打包时执行 
        const handler = this.extractCSS.bind(this, compilation)
        compilation.hooks.afterDistSync.tap("cssExtractPlugin", handler)
    }
}


module.exports = CssExtractPlugin