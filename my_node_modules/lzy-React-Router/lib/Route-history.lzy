import LzyReact, { renderRoute, myUseEffect } from 'lzy-react'

//todo history模式路由页面简易逻辑
function switchRouteHistory(path, id) {
    if (location.pathname === path) return

    // 修改页面path
    history.pushState(null, '', path)
    const element = window.$$routerMap[id].components[path]
    const containerDomFiber = window.$$routerMap[id].containerFiber._child
    renderRoute(element, containerDomFiber)

}

// 定义注册路由
export function Route_H(props, children, fiber) {
    const { path, component } = props

    // 使用useEffect执行默认路由
    if (path === '/') {
        myUseEffect(() => {
            renderRoute(component, fiber._parent)
        })
    }

    return <span></span>
}

// 路由占位组件  是一个div容器
export function RouteContainer_H({ id }, children, fiber) {

    // 创建并挂载容器到全局
    if (!window.$$routerMap) {
        window.$$routerMap = {}
    }

    window.$$routerMap[id] = {
        containerFiber: fiber,
        components: {}
    }

    window.addEventListener('hashchange', changeView)

    // 注册Route
    children.forEach((child) => {
        if (child.tag === 'Route_H') {
            const { path, component } = child.props
            window.$$routerMap[id].components[path] = component
        }
    })


    return <div>{children}</div>
}

// Link组件
export function Link_H(props, children, fiber) {

    const { to, title, id, style } = props
    const linkTo = () => { switchRouteHistory(to, id) }

    return (<a href='javascript:;' onClick={linkTo} style={style}>{title} </a>)
}
